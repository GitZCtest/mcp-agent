# 更新日志

## [2024-12-11] - 模型配置功能 & 系统提示词优化

### ✨ 新增功能

#### 1. 动态模型配置管理

新增了完整的模型参数管理功能，支持运行时动态调整：

**新增命令：**
- `/model <name>` - 切换模型
- `/models` - 列出所有可用模型
- `/config` - 查看当前配置
- `/config <key> <value>` - 修改配置参数

**支持的配置项：**
- `temperature` (0-2) - 控制输出随机性
- `max_tokens` (>0) - 最大输出token数
- `max_iterations` (>0) - 最大工具调用轮数

**核心实现：**
- `agent.py`:
  - `update_model_config()` - 动态更新模型参数
  - `get_model_config()` - 获取当前配置
  - `get_available_models()` - 获取可用模型列表
  - `switch_provider()` - 切换LLM提供商

- `cli.py`:
  - `_switch_model()` - 处理模型切换
  - `_handle_config()` - 处理配置修改
  - `_show_available_models()` - 显示模型列表
  - `_show_current_config()` - 显示当前配置

**使用示例：**
```bash
# 查看可用模型
/models

# 切换到 GPT-4o
/model gpt-4o

# 查看当前配置
/config

# 调整温度参数（更精确的输出）
/config temperature 0.3

# 调整最大token数（更长的输出）
/config max_tokens 16384

# 调整最大迭代次数（更复杂的工具调用）
/config max_iterations 15
```

#### 2. 系统提示词优化

**问题：** 原系统提示词过于保守，导致模型不敢主动调用工具，经常说"我无法直接操作"。

**解决方案：** 重写了默认系统提示词，强调：
- ✅ 主动使用工具完成实际任务
- ✅ 直接执行而不是仅提供建议
- ✅ 明确工具调用能力和使用场景
- ✅ 提供具体的示例对话

**新提示词特点：**
1. **明确能力定位** - 强调拥有真实的工具调用能力
2. **行为指导** - 详细说明何时应该调用工具
3. **示例驱动** - 提供正确和错误的行为示例
4. **用户导向** - 以完成用户任务为核心目标

**效果对比：**

旧提示词：
```
用户："创建一个文件"
模型："我无法直接在你的计算机上创建文件，但你可以..."
```

新提示词：
```
用户："创建一个文件"
模型："好的，我来为你创建文件。[调用write_file工具] 文件已创建成功！"
```

### 🐛 Bug修复

1. **修复 cli.py 语法错误**
   - 修复第460行字符串未正确闭合的问题
   - 修复未使用变量的警告

2. **系统提示词加载逻辑**
   - 确认配置文件中 `system_prompt: ""` 为空时会正确使用默认提示词
   - 这是预期行为，不是bug

### 📚 文档更新

1. **新增 `docs/MODEL_CONFIG.md`**
   - 完整的模型配置功能使用指南
   - 所有命令的详细说明和示例
   - 参数说明和使用场景
   - 故障排除指南

2. **新增 `test_model_config.py`**
   - 模型配置功能的单元测试
   - 参数验证测试

### 🔧 技术细节

**文件修改：**
- `mcp_agent/agent.py` - 新增模型参数管理方法（约120行）
- `mcp_agent/cli.py` - 新增配置管理命令（约150行）
- `mcp_agent/prompts.py` - 重写默认系统提示词（约60行）
- `docs/MODEL_CONFIG.md` - 新增使用文档（约400行）

**特性：**
- ✅ 参数立即生效，无需重启
- ✅ 完整的参数验证
- ✅ 友好的错误提示
- ✅ 美观的表格展示
- ✅ 命令自动补全支持

### 💡 使用建议

#### 场景1：需要更精确的输出
```bash
/config temperature 0.1
```

#### 场景2：需要更有创意的输出
```bash
/config temperature 1.5
```

#### 场景3：处理长文本
```bash
/config max_tokens 16384
```

#### 场景4：复杂的工具调用任务
```bash
/config max_iterations 20
```

#### 场景5：切换到更快的模型
```bash
/model gpt-4o-mini
```

#### 场景6：切换到更强大的模型
```bash
/model gpt-4o
```

### ⚠️ 注意事项

1. **配置不持久化** - 重启程序后配置会恢复到配置文件中的默认值
2. **成本考虑** - 不同模型的成本不同，注意控制使用
3. **参数范围** - 确保参数在有效范围内
4. **工具调用** - 增加 max_iterations 会增加API调用次数

### 🎯 下一步计划

- [ ] 添加配置持久化功能
- [ ] 支持更多模型提供商
- [ ] 添加模型性能统计
- [ ] 支持自定义系统提示词模板
- [ ] 添加配置预设（快速切换场景）

### 🙏 致谢

感谢用户反馈系统提示词的问题，这帮助我们改进了整个工具调用体验！

---

## 快速开始

```bash
# 启动程序
python main.py

# 查看帮助
/help

# 查看可用模型
/models

# 查看当前配置
/config

# 开始使用！
```

更多详细信息请查看 `docs/MODEL_CONFIG.md`。
