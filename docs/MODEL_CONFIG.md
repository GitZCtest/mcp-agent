# 模型配置与切换功能使用指南

本文档介绍如何在运行时动态配置和切换模型参数。

## 功能概述

新增的模型配置功能允许你在不重启程序的情况下：
- 切换不同的 LLM 模型
- 调整模型参数（温度、最大token数等）
- 查看当前配置
- 列出所有可用模型

## 命令列表

### 1. `/models` - 查看可用模型

显示所有支持的模型列表，并标记当前使用的模型。

```bash
MCP Agent> /models
```

**输出示例：**
```
可用模型列表:

ANTHROPIC:
  • claude-3-5-sonnet-20241022
  • claude-3-5-haiku-20241022
  • claude-3-opus-20240229
  • claude-3-sonnet-20240229
  • claude-3-haiku-20240307

OPENAI:
  • gpt-4o
  • gpt-4o-mini
  • gpt-4-turbo
  • gpt-4
  • gpt-3.5-turbo
  • claude-sonnet-4-5-20250929 (当前)
```

### 2. `/model <name>` - 切换模型

切换到指定的模型。

```bash
MCP Agent> /model gpt-4o
```

**输出示例：**
```
✓ 模型已切换为: gpt-4o

┏━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 配置项   ┃ 值                       ┃
┡━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 提供商   │ openai                   │
│ 模型     │ gpt-4o                   │
│ 温度     │ 0.7                      │
│ 最大Token│ 8192                     │
└──────────┴──────────────────────────┘
```

### 3. `/config` - 查看当前配置

显示当前的模型配置参数。

```bash
MCP Agent> /config
```

**输出示例：**
```
当前模型配置:

┏━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
┃ 配置项        ┃ 当前值                   ┃ 说明               ┃
┡━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
│ provider      │ openai                   │ LLM提供商          │
│ model         │ claude-sonnet-4-5-...    │ 模型名称           │
│ temperature   │ 0.7                      │ 温度参数 (0-2)     │
│ max_tokens    │ 8192                     │ 最大输出token数    │
│ max_iterations│ 10                       │ 最大工具调用轮数   │
│ max_history   │ 50                       │ 最大历史消息数     │
└───────────────┴──────────────────────────┴────────────────────┘

使用 /config <key> <value> 修改配置
```

### 4. `/config <key> <value>` - 修改配置参数

动态修改模型参数。

#### 支持的配置项：

| 配置项 | 类型 | 范围 | 说明 |
|--------|------|------|------|
| `temperature` | float | 0-2 | 控制输出的随机性，越高越随机 |
| `max_tokens` | int | >0 | 单次响应的最大token数 |
| `max_iterations` | int | >0 | 工具调用的最大轮数 |

#### 使用示例：

**调整温度参数：**
```bash
MCP Agent> /config temperature 0.3
✓ 温度参数已更新为: 0.3
```

**调整最大token数：**
```bash
MCP Agent> /config max_tokens 4096
✓ 最大token数已更新为: 4096
```

**调整最大迭代次数：**
```bash
MCP Agent> /config max_iterations 15
✓ 最大迭代次数已更新为: 15
```

## 使用场景

### 场景 1：需要更精确的输出

当你需要模型给出更确定、更一致的答案时：

```bash
/config temperature 0.1
```

### 场景 2：需要更有创意的输出

当你需要模型给出更多样化、更有创意的答案时：

```bash
/config temperature 1.5
```

### 场景 3：处理长文本

当需要生成更长的内容时：

```bash
/config max_tokens 16384
```

### 场景 4：复杂的工具调用任务

当任务需要多次工具调用时：

```bash
/config max_iterations 20
```

### 场景 5：切换到更快的模型

当需要快速响应时：

```bash
/model gpt-4o-mini
```

### 场景 6：切换到更强大的模型

当需要处理复杂任务时：

```bash
/model gpt-4o
```

## 参数说明

### Temperature（温度）

- **范围**: 0.0 - 2.0
- **默认值**: 0.7
- **说明**:
  - 0.0: 最确定性，每次输出几乎相同
  - 0.3-0.5: 较为确定，适合事实性任务
  - 0.7-1.0: 平衡创造性和确定性
  - 1.5-2.0: 高度随机，适合创意写作

### Max Tokens（最大token数）

- **范围**: 正整数
- **默认值**: 8192
- **说明**:
  - 控制单次响应的最大长度
  - 1 token ≈ 0.75 个英文单词
  - 1 token ≈ 0.5 个中文字符
  - 设置过小可能导致输出被截断

### Max Iterations（最大迭代次数）

- **范围**: 正整数
- **默认值**: 10
- **说明**:
  - 控制工具调用的最大轮数
  - 每轮可以调用多个工具
  - 设置过小可能导致复杂任务无法完成
  - 设置过大可能导致成本增加

## 注意事项

1. **参数立即生效**: 所有配置修改立即生效，影响下一次对话
2. **不影响历史**: 修改配置不会影响已有的对话历史
3. **配置不持久化**: 重启程序后配置会恢复到配置文件中的默认值
4. **模型切换**: 切换模型后，确保新模型与当前提供商兼容
5. **成本考虑**: 不同模型的成本不同，频繁切换到高级模型会增加成本

## 系统提示词问题说明

关于系统提示词的加载：

1. **配置文件中的 `system_prompt`**:
   - 如果设置为空字符串 `""`，会使用默认系统提示词
   - 如果设置为具体内容，会使用该内容作为系统提示词

2. **默认系统提示词位置**: `mcp_agent/prompts.py` 中的 `PromptTemplates.DEFAULT_SYSTEM_PROMPT`

3. **运行时修改系统提示词**:
   ```bash
   /system 你是一个专业的编程助手，擅长Python和JavaScript开发。
   ```

4. **查看当前系统提示词**: 系统提示词不会在 `/config` 中显示，但会在 `/stats` 中显示部分信息

## 完整工作流示例

```bash
# 1. 查看可用模型
/models

# 2. 切换到快速模型进行测试
/model gpt-4o-mini

# 3. 调整参数以获得更精确的输出
/config temperature 0.3

# 4. 查看当前配置
/config

# 5. 进行对话测试
请帮我写一个Python函数来计算斐波那契数列

# 6. 如果需要更复杂的推理，切换到更强大的模型
/model gpt-4o

# 7. 调整参数以允许更长的输出
/config max_tokens 16384

# 8. 继续对话
请详细解释这个函数的时间复杂度和空间复杂度
```

## 故障排除

### 问题：切换模型后出现错误

**解决方案**:
- 检查 API 密钥是否正确配置
- 确认模型名称拼写正确
- 查看 `/stats` 确认提供商设置

### 问题：配置修改不生效

**解决方案**:
- 使用 `/config` 确认配置已更新
- 检查参数值是否在有效范围内
- 查看日志文件了解详细错误信息

### 问题：系统提示词没有加载

**解决方案**:
- 检查配置文件中的 `system_prompt` 字段
- 使用 `/system` 命令手动设置
- 如果为空，会自动使用默认提示词

## 相关命令

- `/help` - 查看所有可用命令
- `/stats` - 查看系统统计信息
- `/system <prompt>` - 设置系统提示词
- `/clear` - 清除对话历史

## 技术实现

新功能的核心实现：

1. **agent.py**:
   - `update_model_config()` - 动态更新配置
   - `get_model_config()` - 获取当前配置
   - `get_available_models()` - 获取可用模型列表

2. **cli.py**:
   - `_switch_model()` - 处理模型切换
   - `_handle_config()` - 处理配置修改
   - `_show_available_models()` - 显示模型列表
   - `_show_current_config()` - 显示当前配置

3. **config.py**:
   - 配置的读取和验证
   - 环境变量覆盖支持
